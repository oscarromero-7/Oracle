-- CREAMOS NUESTROS LOG (SOLO PARA REFRESH FAST SE CREA)

CREATE MATERIALIZED VIEW LOG ON B_PERSONAS
WITH SEQUENCE, ROWID
(ID, TIPO_PERSONA, NOMBRE, APELLIDO, DIRECCION, TELEFONO, RUC, CEDULA, CORREO_ELECTRONICO, ES_CLIENTE, ES_PROVEEDOR, FECHA_NACIMIENTO, CODIGO_CTA, ID_LOCALIDAD)
INCLUDING NEW VALUES


CREATE MATERIALIZED VIEW LOG ON B_VENTAS
WITH SEQUENCE, ROWID
(ID, NUMERO_FACTURA, FECHA, MONTO_TOTAL, PLAZO, TIPO_VENTA, ID_CLIENTE, CEDULA_VENDEDOR)
INCLUDING NEW VALUES


--CREAMOS NUESTRA VISTA MATERIALIZADA
--CUANDO USAMOS ON COMMIT O ON DEMAND EN NUESTRO LOG DEBEMOS AGREGAR TODAS LAS COLUMNAS DE LA TABLA (PREGUNTAR)

CREATE MATERIALIZED VIEW V_CLI_VENTAS 
	BUILD IMMEDIATE
	REFRESH FAST ON COMMIT
	ENABLE QUERY REWRITE
	AS 
	SELECT V.ID_CLIENTE,
		P.NOMBRE||' '||P.APELLIDO AS "NOMBRE Y APELLIDO",
		SUM(DECODE(V.TIPO_VENTA,'CO',V.MONTO_TOTAL,0)) AS "TOTAL VENTAS CONTADO",
		SUM(DECODE(V.TIPO_VENTA,'CR',V.MONTO_TOTAL,0)) AS "TOTAL VENTAS CREDITO"
	FROM B_PERSONAS P
	INNER JOIN B_VENTAS V ON P.ID = V.ID_CLIENTE
	GROUP BY V.ID_CLIENTE, P.NOMBRE||' '||P.APELLIDO
/
